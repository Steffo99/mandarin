Run the development version
===========================

These are the steps to run Mandarin in development mode.


Start PostgreSQL
----------------

The PostgreSQL server must be running before starting Mandarin.

On ``systemd``\ -based systems, you can start it with the following command:

.. code-block:: bash

    systemctl start postgresql

You can check the status of the PostgreSQL server with ``status`` and ``journalctl``:

.. code-block:: bash

    systemctl status postgresql

.. code-block:: bash

    journalctl -u postgresql


Start Redis
-----------

The Redis server must be running before starting Mandarin.

On ``systemd``\ -based systems, you can start it with the following command:

.. code-block:: bash

    systemctl start redis

You can check the status of the Redis server with ``status`` and ``journalctl``:

.. code-block:: bash

    systemctl status redis

.. code-block:: bash

    journalctl -u postgresql


Start Celery
------------

The various processes of Mandarin use `Celery <https://docs.celeryproject.org/en/stable/>`_ to run various long tasks,
such as the processing of song metadata.

As a first thing, you'll have to start the Celery development server:

.. code-block:: bash

    poetry run python -m celery -A mandarin.taskbus.__main__ worker --loglevel=DEBUG


.. warning:: The IntelliJ/PyCharm debugger does not work with Celery tasks.


Start the web API
-----------------

You can start Mandarin's debug web API with the following command:

.. code-block:: bash

    poetry run python -m mandarin.webapi.apps.debug

The web API will be accessible at ``lo.steffo.eu:30009``, and the autogenerated specification will be available at:

- `/docs <http://lo.steffo.eu:30009/docs>`_ in `SwaggerUI <https://swagger.io/tools/swagger-ui/>`_ format;
- `/redoc <http://lo.steffo.eu:30009/redoc>`_ in `Redoc <https://github.com/Redocly/redoc>`_ format.

If you're using the previously shown config file, you can login as:

- Client ID: ``IJ2VcIYHVkKVpIy02lxr2rMGBibDKuKM``
- Client Secret: ``oZMm8p2RWGezMDCYYDqI2VbYOT6-tJ62n0wnFksvREC8kQXI55BbEEcsccV3SmaW``
- Username: ``demo@steffo.eu``
- Password: ``MONOCULUS!123``

.. todo:: Find a different way to publish Client ID and Client Secret, as this can be abused by malicious actors by
          spamming login requests.